{% extends 'base.html' %}

{% block title %}<title>RERCaptcha DEMO - invisibile</title>{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">RERCaptcha</a></li>
    <li class="breadcrumb-item active" aria-current="page">Invisibile</li>
  </ol>
</nav>
<h2>Form con Captcha invisibile</h2>
<hr>
{% if message %}
<p class="alert alert-light">{{ message }}</p>
{% endif %}
<form method="post">
  <div class="mb-3">
    <label for="text" class="form-label">Campo di testo</label>
    <input type="text" name="text" class="form-control" id="text">
  </div>
  <input type="hidden" name="capjs-token" id="capjs-token">
  <button disabled id="capjs-button" type="submit" class="btn btn-primary">Submit</button>
</form>
<p class="container">
  <!-- <div class="alert alert-light d-flex align-items-center" role="alert">
    <svg xmlns="http://www.w3.org/2000/svg" class="bi flex-shrink-0 me-2" viewBox="0 0 16 16" role="img"
      aria-label="Warning:" style="max-width: 20px;">
      <path
        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
    </svg>
    <div>
      Generalmente il bottone di submit viene impostato come disabilitato e abilitato
      usando l'evento `solve` del captcha (o l'attributo `onsolve` sul widget). In questa demo
      è lasciato sempre abilitato per testare il submit della form senza la verifica.
    </div>
  </div> -->
</p>
<div class="card">
  <div class="card-body">
    <h3 class="card-title">Codice di esempio</h3>
    <p>
      Nel codice di esempio <strong>abcdef1234</strong> è la site_key del sito (informazione pubbblica),
      <strong>aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee</strong> è il secret key, informazione che deve rimanere
      privata solo sul server.
    </p>
  </div>
</div>
<div class="card">
  <div class="card-body">
    <h3 class="card-title">Client (esempio con HTML/Javascript)</h3>
    <pre class="alert alert-light">
      <code>
&lt;body&gt;
  ...
  &lt;form method="post"&gt;
    &lt;div class="mb-3"&gt;
      &lt;label for="text" name="text" class="form-label"&gt;Campo di testo&lt;/label&gt;
      &lt;input type="text" class="form-control" id="text"&gt;
    &lt;/div&gt;
    &lt;input type="hidden" name="capjs-token" id="capjs-token"&gt;
    &lt;button disabled id="capjs-button" type="submit" class="btn btn-primary"&gt;Submit&lt;/button&gt;
  &lt;/form&gt;
  ...
  &lt;script src="https://captcha.regione.emr.it/assets/widget.js"&gt;&lt;/script&gt;
  &lt;script&gt;
    window.CAP_CUSTOM_WASM_URL = "https://captcha.regione.emr.it/assets/cap_wasm.js";
    const cap = new Cap({ apiEndpoint: 'https://captcha.regione.emr.it/<strong>abcdef1234</strong>/' });
    cap.solve().then( ({success, token}) => {
      if (success) {
        document.getElementById('capjs-token').value = token;
        document.getElementById('capjs-button').disabled = false;
      }
      else {
        console.error('error solving captcha');
      }
  &lt;/script&gt;
&lt;/body&gt;
      </code>
    </pre>
  </div>
  <div class="card-body">
    <h3 class="card-title">Server (esempio in python/Flask)</h3>
    <pre class="alert alert-light">
      <code>
        response = request.form["token"]
        res = requests.post(
          f"https://captcha.regione.emr.it/<strong>abcdef1234</strong>/siteverify",
          data={"secret": <strong>aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee</strong>, "response": token},
          timeout=5
        )
        if res:
          result = res.json()
            if result.get("success"):
              # captcha valido
              ...
            else:
              # captcha non valido
              ...
        else:
          # risposta non valida dal server
          ...
      </code>
    </pre>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  const cap = new Cap({ apiEndpoint: '{{ capjs_public_url }}/{{site_key}}/' });
  cap.solve().then(({ success, token }) => {
    if (success) {
      document.getElementById('capjs-token').value = token;
      document.getElementById('capjs-button').disabled = false;
    }
    else {
      console.error('error solving captcha');
    }
  }); 
</script>
{% endblock %}